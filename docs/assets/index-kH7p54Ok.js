(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();function l(n){return n instanceof HTMLElement&&n.tagName.includes("-")}function h(n,e=300){let t;return function(...i){clearTimeout(t),t=setTimeout(()=>n.apply(this,i),e)}}function c(n){const e=":not(:defined)";return[...new Set([n,...n.querySelectorAll(e)])].filter(t=>l(t))}class f{constructor(e){if(this._catalog={},this._namespaces={},this.#e=[],this.#t=!1,this.batches=[],this.batchLoop=void 0,console.log("CEAutoLoader started with options:",e),!e.catalog)throw new Error("CEAutoLoader needs a catalog to start");this.options={live:!0,root:document.body,directives:["eager","lazy","interaction"],defaultDirective:"eager",batchInterval:500,...e},this.catalog=e.catalog,globalThis.DEFINE||u()}#e;#t;get catalog(){return this._catalog}set catalog(e){this._catalog=e,this._namespaces=Object.fromEntries(Object.entries(this._catalog).filter(([t])=>t.endsWith("-*")).map(([t,i])=>[t.split("-")[0],i]))}watch(){const e=new MutationObserver(h(this.watcher.bind(this),100));return e.observe(this.options.root||document.body,{childList:!0,subtree:!0,characterData:!0}),e}async watcher(e){console.log("mutated",e);for(const t of e)if(t.type==="childList")for(const i of t.addedNodes)i.nodeType==1&&i instanceof HTMLElement&&(l(i)||c(i).length>0)&&await this.discover()}filterByDirective(e,t){return t?e.filter(i=>i.getAttribute("on")==t):e.filter(i=>!i.hasAttribute("on"))}uniqueByTag(e){const t=new Set,i=[];for(const r of e){const s=r.tagName;t.has(s)||(t.add(s),i.push(r))}return i}clean(){this.#e?.forEach(e=>e.disconnect()),this.#e=[]}async discover(){this.batches=[],!this.#t&&this.options.live&&this.#e.push(this.watch());for(const t of this.options.directives??[]){const i=this.upgrade(t);Array.isArray(i)&&i[0]instanceof IntersectionObserver&&(this.#e=[...this.#e,...i])}const e=await this.upgrade();return this.batches.length>0&&(this.batchedDefine(this.batches),clearInterval(this.batchLoop),this.batchLoop=void 0),this.flushDefine(),this.#t=!0,e}async upgrade(e){const t=c(this.options.root||document.body),r=this.filterByDirective(t,e);if(e==="lazy"||this.options.defaultDirective==="lazy")return r.map(s=>{const o=new IntersectionObserver(a=>{a[0].isIntersecting&&(this.registerComponents([s]),o.disconnect())});return o.observe(s),o});if(e==="interaction"||this.options.defaultDirective==="interaction")return r.map(s=>s.addEventListener("pointerdown",()=>{this.registerComponents([s])},{once:!0}));if(e==="eager"||this.options.defaultDirective==="eager")return await this.registerComponents(r);debugger;return await this.registerComponents(r)}async registerComponents(e){return await(async()=>(console.log("registering",e.map(r=>r.tagName.toLowerCase())),this.batchLoop||(this.batchLoop=setInterval(async()=>{console.log("flushing batches interval",this.batches.length),await this.batchedDefine(this.batches),requestAnimationFrame(()=>this.flushDefine()),clearInterval(this.batchLoop),this.batchLoop=void 0},this.options.batchInterval)),await Promise.allSettled(e.map(r=>this.registerLeaf(r)))))()}async registerLeaf(e){const t=e.tagName.toLowerCase();try{return await this.loader_run({name:t,el:e})}catch(i){console.error(`ce-autoloader: Error loading ${t}`,i),e.removeAttribute("loading"),this.options.fallback&&(e.setAttribute("error",`${i}`),customElements.get(t)?console.log("Fallback already defined",t):(DEFINE(t,this.options.fallback!==!0?this.options.fallback:DevFallback),await Promise.resolve(requestAnimationFrame)))}}async loader_run(e={}){const t=[this.find.bind(this),this.beforeLoad.bind(this),this.load.bind(this),this.afterLoad.bind(this),this.define.bind(this),this.finished.bind(this)];let i=0;async function r(s){const o=t[i++];try{return await o(s,r)}catch(a){return Promise.reject(a)}}return r(e)}async find({name:e,el:t},i){let r=this._catalog[e]||this.getNamespace(e);if(!r)throw new Error(`Component not found: ${e}`);return i({name:e,el:t,asset:r})}async beforeLoad({name:e,el:t,asset:i},r){return r({name:e,el:t,asset:i})}async load({name:e,el:t,asset:i},r){performance.mark(`load:${e}:start`);let s;if(typeof i=="string")s=await import(i);else if(typeof i=="function")s=await i(e);else throw new Error(`ce-autoloader: Loader of ${e} is invalid! Should be a url or a function`);return performance.mark(`load:${e}:end`),performance.measure(`load:${e}`,`load:${e}:start`,`load:${e}:end`),r({name:e,el:t,asset:i,module:s})}async afterLoad({name:e,el:t,asset:i},r){this.batches.push(async()=>await r({name:e,asset:i}))}async define({name:e,el:t,asset:i},r){if(performance.mark(`define:${e}:start`),customElements.get(e))return performance.mark(`define:${e}:end`),performance.measure(`define:${e}`,`define:${e}:start`,`define:${e}:end`),r({name:e,el:t,asset:i});const{ctor:s,options:o}=customElements.waiting[e];return DEFINE(e,s,o),performance.mark(`define:${e}:end`),performance.measure(`define:${e}`,`define:${e}:start`,`define:${e}:end`),r({name:e,asset:i})}async finished({name:e,el:t,asset:i},r){return r({name:e,el:t,asset:i})}async batchedDefine(e){if(e.length===0)return;console.log("flushing",this.batches.length);const t=document.startViewTransition(async()=>Promise.allSettled(e.map(i=>i())));try{await t.ready,performance.mark("viewTransition:start"),await t.finished,performance.mark("viewTransition:end"),performance.measure("viewTransition","viewTransition:start","viewTransition:end")}catch(i){console.error("View transition failed:",i)}this.batches=[]}getNamespace(e){const[t,i]=e.split("-");return this._namespaces[t]}flushDefine(){console.log("defines in waiting",Object.keys(customElements.waiting)),Object.keys(customElements.waiting).length>0&&Object.entries(customElements.waiting).filter(([e])=>!customElements.get(e)).map(([e,{ctor:t,options:i}])=>DEFINE(e,t,i))}}function u(){globalThis._DEFINE=customElements.define.bind(customElements),globalThis.DEFINE=(n,e,t)=>{globalThis._DEFINE(n,e,t),delete customElements.waiting[n]},customElements.waiting={},customElements.define=function(n,e,t){customElements.waiting[n]={ctor:e,options:t}}}export{f as C};
