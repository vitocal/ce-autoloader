<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEAutoLoader Test</title>
    <link rel="stylesheet" href="https://esm.sh/@awesome.me/webawesome@3.0.0/dist/styles/themes/default.css"
        media="none" onload="if(media!='all')media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/dist/themes/prism.min.css">
    <style>
        @layer openprops, normalize, theme, components.root, components.extended, utils;

        @import "https://unpkg.com/open-props";
        @import "https://unpkg.com/open-props/normalize.min.css";
        @import "https://unpkg.com/open-props/buttons.min.css";
        @import "https://unpkg.com/open-props/normalize.light.min.css";

        /* 1. Use a more-intuitive box-sizing model */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        /* 2. Remove default margin */
        * {
            margin: 0;
        }

        :root {
            --color-primary: #e31;
            --color-secondary: rgba(148, 163, 184, 0.55);
            --color-accent: #333;
            --color-bg-dark: #ddd;
            --color-bg: #eee;
            --color-bg-light: #fff;
            --color-fg: #333;

            --spring-easing: linear(0, 0.0092, 0.0345, 0.0726, 0.1205, 0.1757, 0.2358, 0.299, 0.3635, 0.428, 0.4913, 0.5525, 0.6109, 0.6659, 0.7172, 0.7644, 0.8075, 0.8465, 0.8812, 0.912, 0.9389, 0.9621, 0.9819, 0.9985, 1.0122, 1.0233, 1.032, 1.0386, 1.0433, 1.0464, 1.0482, 1.0487, 1.0483, 1.0471, 1.0453, 1.043, 1.0403, 1.0374, 1.0343, 1.0312, 1.028, 1.025, 1.022, 1.0191, 1.0164, 1.0139, 1.0116, 1.0095, 1.0076, 1.0059, 1.0044, 1.003, 1.0019, 1.0009, 1.0001, 0.9994, 0.9989, 0.9985, 0.9981, 0.9979, 0.9977, 0.9977, 0.9976, 0.9976, 0.9977, 0.9978, 0.9979, 0.998, 0.9982, 0.9983, 0.9985, 0.9986, 0.9988, 0.9989, 0.9991, 0.9992, 0.9993, 0.9994, 0.9995, 0.9996, 0.9997, 0.9998, 0.9998, 0.9999, 1, 1, 1, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1);
            --spring-duration: 0.73s;
        }



        body {
            max-width: 80%;
            margin: 0 auto;
        }

        body>*+* {
            margin-top: 1em;
        }

        .animation-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            justify-content: center;
            justify-items: center;
            align-content: center;
            align-items: center;
            gap: 1rem;

        }

        .animation-overview .box {
            display: inline-block;
            width: 100px;
            height: 100px;
            background-color: var(--wa-color-brand-fill-loud);
            margin: 1.5rem;
        }

        pre {
            box-sizing: border-box;
            max-width: 100%;
            white-space: pre;
            /* preserve spaces/newlines exactly */
            overflow-x: auto;
            /* show horizontal scrollbar when needed */
            -webkit-overflow-scrolling: touch;
            /* smooth scrolling on iOS */
            padding: .6rem;
            background-color: var(--color-bg);
            border-radius: 0.33em;
            box-shadow: var(--shadow-6);
        }



        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        :not(:defined) {
            display: inline-flex;
            /* background-color: var(--color-secondary); */
            background: radial-gradient(circle at 0 0, var(--color-bg), var(--color-bg));
            border: 1px dashed var(--color-secondary);
            color: var(--color-fg);
            opacity: 1;
            width: fit-content;
            min-height: 1em;
            padding: 0.35em;
            border-radius: 0.5em;
        }

        [loading] {
            border: 1px dashed var(--color-secondary);
            position: relative;
            overflow: clip;

            &::after {
                pointer-events: none;
                content: " ";
                position: absolute;
                transform: translateX(-100%);
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg,
                        transparent,
                        #0006 20%,
                        #0005 60%,
                        transparent);
                animation: shimmer 1s ease-in-out infinite;
                z-index: 0;
            }
        }

        [ready] {
            box-shadow: var(--shadow-4);
            border-radius: var(--radius-2);
            overflow: hidden;
            overflow-clip-margin: 1em;
        }


        /**
         * Animations
         */

        vi-switch {
            height: 100%;
            display: inline-flex;
        }

        /* disable view transition root animation */
        /* ::view-transition-group(:root) {
            animation: none;
        } */

        ::view-transition-group(.vi-switch) {
            animation-duration: 5s;
        }

        ::view-transition-old(.vi-switch) {
            width: 100%;
            height: 100%;
            object-position: left;
        }

        ::view-transition-new(.vi-switch) {
            height: 100%;
            object-position: left;
        }


        ::view-transition-group(.three-cube) {
            animation-timing-function: var(--spring-easing);
            animation-duration: var(--spring-duration);
            /* overflow: clip;
            animation: none; */
        }

        ::view-transition-image-pair(.three-cube) {
            overflow: clip;
            overflow-clip-margin: 2em;
        }

        ::view-transition-old(.three-cube),
        ::view-transition-new(.three-cube) {
            width: auto;
            height: 100%;

        }

        ::view-transition-old(.three-cube) {
            height: auto;
        }




        @keyframes grow {
            from {
                height: 50%;
            }

            80% {
                height: 50%;
            }

            to {
                height: 100%;
            }
        }

        @keyframes shrink {
            from {
                height: 100%;
            }

            20% {
                height: 50%;
            }

            to {
                height: 50%;
            }
        }


        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes slide-in {
            0% {
                transform: translateX(-33%);
            }

            100% {
                transform: translateX(0);
            }
        }

        @keyframes slide-out {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-33%);
            }
        }

        @keyframes fade-in {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes fade-out {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "lit": "/node_modules/vite/deps/lit.js",
        }
    }
    </script>
</head>

<body>
    <h1>ce-autoloader</h1>
    <p>Load web-components on demand, if and when they're used in the page.</p>

    <ul>
        <li>Automatically Load any web-component on demand, if and when they're used in the page.</li>
        <li>A central registry of components, similar to import maps</li>
        <li>Customize when components are loaded with with loading attribute, `on="idle"` , `on="lazy"`,
            `on="interaction"`</li>
        <li>Simple and ergonomic </li>
        <li>No dependencies, framework-independent</li>
        <li>1.7kb gzip, performant! </li>
        <li>Namespaced components - Lazily load any component from any library</li>
    </ul>

    <!-- <not-loaded>
        Hello World, i'm not defined yet!
    </not-loaded> -->

    <vi-hello></vi-hello>

    <h2>Examples - Loading Attribute</h2>

    <h3 data-loading>Autoloaded by default</h3>
    <wa-button>wa-button</wa-button>

    <h3>idle</h3>
    <vi-switch on="idle">
        idle
    </vi-switch>

    <h3>interaction - Click or touch</h3>
    <three-cube on="interaction">
        <span>Click for 3d cube</span>
    </three-cube>

    <h3>lazy - when element is visible in the viewport</h3>

    <div class="animation-overview">
        <wa-animation name="bounce" on="lazy" duration="2000" iterations="1" play>
            <div class="box"></div>
        </wa-animation>
        <wa-animation name="fadeIn" on="lazy" duration="2000" iterations="1" play>
            <div class="box"></div>
        </wa-animation>
        <wa-animation name="fadeIn" on="lazy" duration="2000" iterations="1" play>
            <div class="box"></div>
        </wa-animation>
        <wa-animation name="flip" on="lazy" duration="2000" iterations="1" play>
            <div class="box"></div>
        </wa-animation>
    </div>

    <h3>manual</h3>

    <p>When you want more control, you can upgrade a component manually, by using a custom directive name
        and calling `registry.upgrade('myDirective')`
    </p>
    <confetti-button on="manual">
        <button id="confetti">Confetti</button>
    </confetti-button>
    <script type="module">
        document.getElementById("confetti").addEventListener("click", async () => {
            if (!customElements.get('confetti-button')) {
                let result = await registry.upgrade('manual')
                console.log('result', result);
            }
        });
    </script>

    <h2>Namespaced Components</h2>
    <p>You can lazily import a whole library of components by using namespace `myns-*`</p>
    <p>For example, here we register everything under `wa-*` namespace, so any component like `wa-qr-code` will
        automatically call our loader function!</p>

    <wa-qr-code></wa-qr-code>

    <p> Heres a example of the namespace loader for `wa-*` with syntax-highlight </p>

    <pre>
    <syntax-highlight language="js">
{
    // ...
    "wa-*": async (full_name) => {
        const [, namespace, name] = full_name.match(/^([a-z]+)-(.*)/);
        try {
            const module = await import(
                /* @vite-ignore */
                `https://esm.sh/@awesome.me/webawesome/dist/components/${name}/${name}.js`
                );
                if (!customElements.get(full_name)) {
                    customElements.define(full_name, module.default);
                }
            } catch (error) {
                console.error(`Failed to load component ${full_name}:`, error);
            }
        },
}
</syntax-highlight>
</pre>

    <hr>

    <!-- Observability/Performance -->
    <h1>Observability & Performance</h1>

    <p>
        Observability is already built-in to the registry, and allows measuring the time-to-load of each component.
        With native `performance` integration, it shows in devtools performance panel and can be exported to your
        observability metrics as usual.
    </p>

    <img src="/assets/observability.jpg" alt="Observability has native integration into performance devtools">

    <p>
        You can access the metrics by querying `performance.getEntriesByName('load:my-component')`
    </p>

    <!-- Animation -->
    <h1>Animating enter/exit of components</h1>

    <p>It's possible to animate the components upgrade lifecycle. </p>

    <wc-markdown>
        <script type="wc-content">
            ### Animation feature

            - [x] Implement a hook to allow document.startViewTransition() before loading (transition: callback)
            - [X] Implement a [data-loading] and [ready] attributes
            - [ ] How to start the transition right after the module is loaded, but the DOM
                  was not changed yet.

                  Thats hard, because if we startViewTransition(registry.registerComponents), then
                  it starts before the loading of the module, and only concludes after, taking many seconds
                  without updating the UI.

                  If we startViewTransition after it's defined, then it's too late, because the DOM was already
                  changed.


        </script>
    </wc-markdown>

    <json-viewer id="json" expand="**">
        { "quiz": { "sport": { "q1": { "question": "Which one is correct team name in NBA?", "options": [ "New York
        Bulls", "Los Angeles Kings", "Golden State Warriros", "Houston Rockets" ], "answer": "Houston Rockets" } },
        "maths": { "q1": { "question": "5 + 7 = ?", "options": [ "10", "11", "12", "13" ], "answer": "12" }, "q2": {
        "question": "12 - 8 = ?", "options": [ "1", "2", "3", "4" ], "answer": "4" } } } }
    </json-viewer>
    <script>
        customElements.whenDefined('json-viewer').then(() => {
            const el = document.getElementById('json');

            el.expandAll();
        })
    </script>

    <script class="echo reflect" type="module" contenteditable="true">
        // import CERegistry from 'https://esm.sh/ce-autoloader';
        import CERegistry from './src/index.js';

        const ViComponents = (await import('./src/components/vi')).default;
        const PixComponents = (await import('./src/components/pix')).default;

        const catalog = {
            "wa-button": "https://esm.sh/@awesome.me/webawesome/dist/components/button/button.js",
            "wa-animation": "https://esm.sh/@awesome.me/webawesome/dist/components/animation/animation.js",
            "wa-*": async (full_name) => {
                const [, namespace, name] = full_name.match(/^([a-z]+)-(.*)/);
                try {
                    const module = await import(/* @vite-ignore */ `https://esm.sh/@awesome.me/webawesome/dist/components/${name}/${name}.js`);
                    if (!customElements.get(full_name)) {
                        customElements.define(full_name, module.default);
                    }
                    return module
                } catch (error) {
                    console.error(`Failed to load component ${full_name}:`, error);
                }
            },
            "syntax-highlight": "https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/+esm",
            "playground-ide": "https://esm.sh/playground-elements@0.18.1/playground-ide.js",
            "notfound-component": "/src/components/notfound-component.ts",
            "confetti-button": "/src/components/confetti-button.ts",
            "three-cube": "/src/components/three-cube.js",
            "json-viewer": "https://esm.sh/@alenaksu/json-viewer",
            "wc-markdown": "https://cdn.skypack.dev/@vanillawc/wc-markdown",
            ...ViComponents,
            ...PixComponents
        };

        class MyCustomRegistry extends CERegistry {

            async beforeLoad({ name, asset }, next) {
                const el = document.querySelector(name);
                console.log("beforeLoad", name, el, asset);
                try {
                    // add loading/transition-class to all components
                    el.setAttribute('loading', 'true');

                    await next({ name, asset });

                } finally {
                    el.removeAttribute('loading');
                    el.setAttribute('ready', "");
                }
            }

            async afterLoad({ name, asset }, next) {
                console.log("afterLoad", name, asset);
                const el = document.querySelector(name);

                el.style.viewTransitionName = 'match-element';
                el.style.viewTransitionClass = el.tagName.toLowerCase();

                const transition = document.startViewTransition(async () => {
                    await next({ name, asset });
                    el.removeAttribute('data-loading');
                    el.setAttribute('ready', "");
                });

                await transition.ready;
                performance.mark(`viewTransition:${name}:start`);
                await transition.finished
                performance.mark(`viewTransition:${name}:end`);
                performance.measure(`viewTransition:${name}`, `viewTransition:${name}:start`, `viewTransition:${name}:end`);
            }
        }

        globalThis.registry = new MyCustomRegistry({
            catalog,
            root: document.body,
            live: true,
            fallback: false,
        });
        console.log(await registry.discover());


        async function metrics() {
            await Promise.allSettled(
                Object.keys(catalog).map(async (name) => {
                    await customElements.whenDefined(name)
                    await new Promise(requestAnimationFrame)

                    const loaded = performance.getEntriesByName(`load:${name}`);
                    const duration = loaded[0].duration;

                    console.log(`${name} loaded in ${duration.toFixed(2)}ms`);
                })
            );
        }

        await metrics();

    </script>

    <footer>
        <p>Created by <a href="https://github.com/vitorcalejuri">Vitor Calejuri</a></p>
    </footer>
</body>

</html>