<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEAutoLoader Test</title>

    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/dist/themes/prettylights.min.css">
    <style>
        @layer normalize, theme, ds, components.root, components.extended, utils;
        @import "https://nordcdn.net/ds/css/4.2.0/nord.min.css" layer(ds);

        @layer normalize {

            /* 1. Use a more-intuitive box-sizing model */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }

            /* 2. Remove default margin */
            * {
                margin: 0;
            }
        }

        @layer theme {
            :root {
                --color-primary: #e31;
                --color-secondary: rgba(148, 163, 184, 0.55);
                --color-accent: #333;
                --color-bg-dark: #ddd;
                --color-bg: #eee;
                --color-bg-light: #fff;
                --color-fg: #333;

                --color-success: rgb(11, 185, 34);
                --color-warning: rgb(255, 243, 72);
                --color-danger: #e31;

                --spring-easing: linear(0, 0.0092, 0.0345, 0.0726, 0.1205, 0.1757, 0.2358, 0.299, 0.3635, 0.428, 0.4913, 0.5525, 0.6109, 0.6659, 0.7172, 0.7644, 0.8075, 0.8465, 0.8812, 0.912, 0.9389, 0.9621, 0.9819, 0.9985, 1.0122, 1.0233, 1.032, 1.0386, 1.0433, 1.0464, 1.0482, 1.0487, 1.0483, 1.0471, 1.0453, 1.043, 1.0403, 1.0374, 1.0343, 1.0312, 1.028, 1.025, 1.022, 1.0191, 1.0164, 1.0139, 1.0116, 1.0095, 1.0076, 1.0059, 1.0044, 1.003, 1.0019, 1.0009, 1.0001, 0.9994, 0.9989, 0.9985, 0.9981, 0.9979, 0.9977, 0.9977, 0.9976, 0.9976, 0.9977, 0.9978, 0.9979, 0.998, 0.9982, 0.9983, 0.9985, 0.9986, 0.9988, 0.9989, 0.9991, 0.9992, 0.9993, 0.9994, 0.9995, 0.9996, 0.9997, 0.9998, 0.9998, 0.9999, 1, 1, 1, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1.0001, 1);
                --spring-duration: 0.73s;

                --spacing-xs: 0.25rem;
                --spacing-sm: 0.5rem;
                --spacing-md: 1rem;
                --spacing-lg: 1.5rem;
                --spacing-xl: 2rem;
                --spacing-2xl: 3rem;
                --spacing-3xl: 4rem;
                --spacing-4xl: 5rem;
                --spacing-5xl: 6rem;
                --spacing-6xl: 7rem;
                --spacing-7xl: 8rem;
                --spacing-8xl: 9rem;
                --spacing-9xl: 10rem;
            }
        }

        body {
            max-width: 90%;
            margin: 0 auto;
        }

        body>*+* {
            margin-top: 1em;
        }

        .container {
            display: grid;
            grid-template-columns:
                [left-start] 1fr [center-start] 4fr [center-end right-start] 1fr [right-end];
            grid-template-rows: auto;
            grid-gap: 1em;

            /* default spans 3 columns */
            &>* {
                grid-column: 1 / -1;
            }

            /* Optional placement areas */
            .left {
                grid-column: left-start / center-start;
            }

            .center {
                grid-column: center-start / center-end;
            }

            .right {
                grid-column: right-start / right-end;
            }

            /* Combined areas */
            .leftcenter {
                grid-column: left-start / center-end;
                /* alias explained below */
            }

            .centerright {
                grid-column: center-start / right-end;
            }
        }


        img {
            max-width: 100%;
        }

        pre {
            box-sizing: border-box;
            display: block;
            max-width: 100%;

            font-size: 12px;

            &:has(code, syntax-highlight) {
                white-space: pre-wrap;
                word-break: break-all;

                tab-size: 2;
                overflow: auto;
            }

            syntax-highlight {
                padding: .5rem 1rem 1rem;
                display: inline-block;
                max-inline-size: 100%;
                width: 100%;
                position: relative;
                border-radius: .5rem;
                overflow: auto;
            }
        }

        code {
            font-size: 12px;
            background-color: var(--color-bg-dark);
            padding: 0.25rem 0.5rem;
        }






        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        @layer components.root {
            :not(:defined) {
                visibility: visible;
                display: inline-block;
                color: var(--color-fg);
                outline: 2px dashed var(--color-secondary);
                outline-offset: 4px;

                width: fit-content;
                min-height: 1em;
                padding: 0.35em;
                border-radius: 0.5em;
                overflow: hidden;
                overflow-clip-margin: 0.5em;

                position: relative;

            }

            [loading] {
                outline: 2px dashed var(--color-secondary);
                position: relative;
                overflow: clip;

                &::after {
                    pointer-events: none;
                    content: " ";
                    position: absolute;
                    transform: translateX(-100%);
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg,
                            transparent,
                            #0006 20%,
                            #0005 60%,
                            transparent);
                    animation: shimmer 1s ease-in-out infinite;
                    z-index: 0;
                }
            }

            [ready] {
                outline: 2px dashed transparent;
                outline-offset: 0.25em;
                overflow: hidden;
                overflow-clip-margin: 0.5em;
                visibility: visible;

                animation: outline-highlight 0.7s ease-in-out 5 alternate;
            }
        }


        /**
         * Animations
         */
        /* ::view-transition-group(*) {
            animation: none;
        } */

        vi-switch {
            height: 100%;
            display: inline-flex;
        }


        /* ::view-transition-group(*) {
            animation: none;
            animation-duration: 1s;
        }

        ::view-transition-old(*) {
            width: 100%;
            height: 100%;
            object-position: left;
        }

        ::view-transition-new(*) {
            height: 100%;
            object-position: left;
        } */

        /* disable view transition root animation */
        ::view-transition-group(root) {
            animation: none;
        }

        ::view-transition-new(root),
        ::view-transition-old(root) {
            animation: none;
        }

        /* */
        ::view-transition-group(*.three-cube) {
            animation-timing-function: var(--spring-easing);
            animation-duration: var(--spring-duration);
        }


        ::view-transition-image-pair(*.three-cube) {
            overflow: clip;
            overflow-clip-margin: 2em;
        }

        ::view-transition-old(*.three-cube),
        ::view-transition-new(*.three-cube) {
            width: auto;
            height: 100%;
        }

        ::view-transition-old(*.three-cube) {
            animation-name: blur-out;
            height: auto;
        }

        @keyframes grow {
            from {
                height: 50%;
            }

            80% {
                height: 50%;
            }

            to {
                height: 100%;
            }
        }

        @keyframes shrink {
            from {
                height: 100%;
            }

            20% {
                height: 50%;
            }

            to {
                height: 50%;
            }
        }


        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes slide-in {
            0% {
                transform: translateX(-33%);
            }

            100% {
                transform: translateX(0);
            }
        }

        @keyframes slide-out {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-33%);
            }
        }

        @keyframes fade-in {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes fade-out {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes blur-out {
            0% {
                filter: blur(0);
                opacity: 1;
            }

            100% {
                filter: blur(10px);
                opacity: 0;
            }
        }

        @keyframes outline-highlight {
            0% {
                outline-color: var(--color-secondary);
            }

            50% {
                outline-color: var(--color-success);
            }

            100% {
                outline-color: var(--color-secondary);
            }
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "lit": "/node_modules/vite/deps/lit.js"
        }
    }
    </script>
</head>

<body class="container n-reset">
    <h1>ce-autoloader</h1>
    <p>Load web-components on demand, if and when they're used in the page.</p>

    <ul>
        <li>Automatically Load any web-component on demand, if and when they're used in the page.</li>
        <li>A central registry of components, similar to import maps</li>
        <li>Customize when components are loaded with with loading attribute, `on="idle"` , `on="lazy"`,
            `on="interaction"`</li>
        <li>Simple and ergonomic </li>
        <li>No dependencies, framework-independent</li>
        <li>1.7kb gzip, performant! </li>
        <li>Namespaced components - Lazily load any component from any library</li>
    </ul>

    <h1> Usage </h1>

    <p>Import <code>ce-autoloader</code> and declare your component registry. Call <code>discover()</code>
        when you're ready, generally after <strong>load</strong>.

    </p>

    <pre>
<syntax-highlight language="js">import CERegistry from 'ce-autoloader';
import { * as mycomps } from './src/components';

/** A unified registry for all your components */
const catalog = {
    ...mycomps,
    "nord-button": "https://unpkg.com/@nord-ui/button@1.0.0/dist/nord-button.js",
    // ...
}
const registry = new CERegistry({catalog, root: document.body});

// Start when you're ready
await registry.discover();
</syntax-highlight>
</pre>

    <h2>Examples - Loading Attribute</h2>

    <h3>Autoloaded by default</h3>
    <nord-button>nord-button</nord-button>

    <h3>Nord Health</h3>
    <nord-stack gap="m" direction="horizontal">
        <nord-button href="#">Default</nord-button>
        <nord-button href="#" variant="primary">Primary</nord-button>
        <nord-button href="#" variant="danger">Danger</nord-button>
        <nord-button href="#" variant="dashed">
            <nord-icon name="interface-filter"></nord-icon>
            Filter
        </nord-button>
        <nord-button href="#" square>
            <nord-icon name="interface-menu-small" label="Options"></nord-icon>
        </nord-button>
    </nord-stack>

    <h3>idle</h3>
    <vi-switch on="idle">
        idle
    </vi-switch>

    <h3>interaction - Click or touch</h3>
    <three-cube on="interaction">
        <span>Click for 3d cube</span>
    </three-cube>

    <h3>lazy - when element is visible in the viewport</h3>

    <nord-stack gap="m">
        <nord-message highlight unread>
            Ariel Salminen arrived to clinic with Pixie cat.
            <span slot="footer">Just now at Nord Clinic</span>
        </nord-message>
        <nord-message unread>
            Nina Hallikainen arrived to clinic with Durante dog.
            <span slot="footer">20 minutes ago at Nord Clinic</span>
        </nord-message>
        <nord-message unread>
            David Darnes arrived to clinic with Norfryd cat.
            <span slot="footer">2 hours ago at Nord Clinic</span>
        </nord-message>
    </nord-stack>

    <h3>Table</h3>

    <nord-banner variant="success">
        Your order has been shipped and will arrive on May 27th. <a href="#">Track order</a>.
    </nord-banner>

    <nord-dropdown size="s" style="z-index: 1;">
        <nord-button slot="toggle">Menu</nord-button>
        <nord-dropdown-item href="#">View profile</nord-dropdown-item>
        <nord-dropdown-item>Settings</nord-dropdown-item>
        <nord-dropdown-item>Show keyboard shortcuts</nord-dropdown-item>
        <nord-dropdown-item>Help & Support</nord-dropdown-item>
        <nord-dropdown-item>API</nord-dropdown-item>
        <nord-dropdown-item>Sign out</nord-dropdown-item>
    </nord-dropdown>

    <nord-table on="lazy">
        <table>
            <thead>
                <tr>
                    <th class="n-table-align-right">Amount</th>
                    <th>Description</th>
                    <th>Method</th>
                    <th class="n-table-align-right">Date</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="n-table-align-right">350,00&thinsp;‚Ç¨</td>
                    <td class="n-table-ellipsis">
                        Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
                        amet
                        consectetuer
                        adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
                        dolor
                        sit amet
                        consectetuer adipiscing
                    </td>
                    <td>Card</td>
                    <td class="n-table-align-right">20.3.2021</td>
                </tr>
                <tr>
                    <td class="n-table-align-right">29,90&thinsp;‚Ç¨</td>
                    <td class="n-table-ellipsis">
                        Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
                        amet
                        consectetuer
                        adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
                        dolor
                        sit amet
                        consectetuer adipiscing
                    </td>
                    <td>Card</td>
                    <td class="n-table-align-right">19.3.2021</td>
                </tr>
                <tr>
                    <td class="n-table-align-right">50,00&thinsp;‚Ç¨</td>
                    <td class="n-table-ellipsis">
                        Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
                        amet
                        consectetuer
                        adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
                        dolor
                        sit amet
                        consectetuer adipiscing
                    </td>
                    <td>Card</td>
                    <td class="n-table-align-right">18.3.2021</td>
                </tr>
                <tr>
                    <td class="n-table-align-right">290,00&thinsp;‚Ç¨</td>
                    <td class="n-table-ellipsis">
                        Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
                        amet
                        consectetuer
                        adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
                        dolor
                        sit amet
                        consectetuer adipiscing
                    </td>
                    <td>Card</td>
                    <td class="n-table-align-right">17.3.2021</td>
                </tr>
                <tr>
                    <td class="n-table-align-right">49,90&thinsp;‚Ç¨</td>
                    <td class="n-table-ellipsis">
                        Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
                        amet
                        consectetuer
                        adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
                        dolor
                        sit amet
                        consectetuer adipiscing
                    </td>
                    <td>Card</td>
                    <td class="n-table-align-right">16.3.2021</td>
                </tr>
                <tr>
                    <td class="n-table-align-right">25,00&thinsp;‚Ç¨</td>
                    <td class="n-table-ellipsis">
                        Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
                        amet
                        consectetuer
                        adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
                        dolor
                        sit amet
                        consectetuer adipiscing
                    </td>
                    <td>Card</td>
                    <td class="n-table-align-right">15.3.2021</td>
                </tr>
            </tbody>
        </table>
    </nord-table>

    <h3>manual</h3>

    <p>When you want more control, you can upgrade a component manually, by using a custom directive name
        and calling `registry.upgrade('myDirective')`
    </p>
    <confetti-button on="manual">
        <nord-button id="confetti" size="l" variant="primary">Throw confetti üéâ</nord-button>
    </confetti-button>
    <script type="module">
        document.getElementById("confetti").addEventListener("click", async () => {
            if (!customElements.get('confetti-button')) {
                let result = await registry.upgrade('manual')
                console.log('result', result);
            }
        });
    </script>

    <hr />
    <h1>Namespaced Components</h1>

    <p>You can lazily import a whole library of components by using namespace <code>myns-*</code></p>
    <p class="leftcenter">
        For example, here we register everything under <code>nord-*</code> namespace, so any component like
        <code>nord-qr-code</code> will
        automatically load! There's no need to declare/import each component manually.
    </p>

    <figure class="right">
        <nord-qrcode value="https://ce-autoloader.com"></nord-qrcode>
        <figcaption>
            Send me a ‚ù§Ô∏è via pix
        </figcaption>
    </figure>

    <p> Heres the full loader for <code>nord-*</code></p>

    <pre>
<syntax-highlight language="js">/**
 * Nord Health design system
 */
"nord-*": async (full_name) => {
    const [, namespace, name] = full_name.match(/^([a-z]+)-(.*)/);
    const module = await import(/* @vite-ignore */ `https://esm.sh/@nordhealth/components/lib/${capitalize(name)}.js`);
    if (!customElements.get(full_name)) {
        customElements.define(full_name, module.default);
    }
    return module
},</syntax-highlight>
</pre>

    <hr>

    <h1>Observability & Performance</h1>

    <p>
        Observability is already built-in to the registry, and allows measuring the time-to-load of each component.
        With native `performance` integration, it shows in devtools performance panel and can be exported to your
        observability metrics as usual.
    </p>

    <img src="/assets/observability.jpg" alt="Observability has native integration into performance devtools">

    <p>
        You can access the metrics by querying `performance.getEntriesByName('load:my-component')`
    </p>

    <h1>Animating enter/exit of components</h1>

    <p>It's possible to animate the components upgrade lifecycle. </p>

    <wc-markdown>
        <script type="wc-content">
            ### Animation feature

            - [x] Implement a hook to allow document.startViewTransition() before loading (transition: callback)
            - [X] Implement a [data-loading] and [ready] attributes
            - [X] How to start the transition right after the module is loaded, but the DOM
                  was not changed yet.


            Thats hard, because if we startViewTransition(registry.registerComponents), then
            it starts before the loading of the module, and only concludes after, taking many seconds
            without updating the UI.

            If we startViewTransition after it's defined, then it's too late, because the DOM was already
            changed.
        </script>
    </wc-markdown>

    <json-viewer id="json" expand="**">
        { "quiz": { "sport": { "q1": { "question": "Which one is correct team name in NBA?", "options": [ "New York
        Bulls", "Los Angeles Kings", "Golden State Warriros", "Houston Rockets" ], "answer": "Houston Rockets" } },
        "maths": { "q1": { "question": "5 + 7 = ?", "options": [ "10", "11", "12", "13" ], "answer": "12" }, "q2": {
        "question": "12 - 8 = ?", "options": [ "1", "2", "3", "4" ], "answer": "4" } } } }
    </json-viewer>
    <script>
        customElements.whenDefined('json-viewer').then(() => {
            const el = document.getElementById('json');

            el.expandAll();
        })
    </script>

    <script class="echo reflect" type="module" contenteditable="true">
        // import CERegistry from 'https://esm.sh/ce-autoloader';
        import CERegistry from './src/index.js';

        const ViComponents = (await import('./src/components/vi')).default;
        const PixComponents = (await import('./src/components/pix')).default;


        const capitalize = (str) =>
            str.split('-').map((word) => word.charAt(0).toUpperCase() + word.slice(1)).join('');

        globalThis.process = {
            env: {
                NODE_ENV: 'development'
            }
        }

        const catalog = {

            /**
             * Nord Health design system
             */
            "nord-*": async (full_name) => {
                const [, namespace, name] = full_name.match(/^([a-z]+)-(.*)/);
                const module = await import(/* @vite-ignore */ `https://esm.sh/@nordhealth/components/lib/${capitalize(name)}.js`);
                if (!customElements.get(full_name)) {
                    customElements.define(full_name, module.default);
                }
                return module
            },
            "syntax-highlight": "https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/+esm",
            "playground-ide": "https://esm.sh/playground-elements@0.18.1/playground-ide.js",
            "notfound-component": "/src/components/notfound-component.ts",
            "confetti-button": "/src/components/confetti-button.ts",
            "three-cube": "/src/components/three-cube.js",
            "json-viewer": "https://esm.sh/@alenaksu/json-viewer",
            "wc-markdown": "https://cdn.skypack.dev/@vanillawc/wc-markdown",
            ...ViComponents,
            ...PixComponents
        };

        class MyCustomRegistry extends CERegistry {

            async beforeLoad({ name, el, asset }, next) {
                performance.mark(`load:${name}:start`);

                // add loading/transition-class to all components
                el.setAttribute('loading', 'true');

                await next({ name, el, asset });
            }

            async afterLoad({ name, el, asset }, next) {
                performance.mark(`load:${name}:end`);
                performance.measure(`load:${name}`, `load:${name}:start`, `load:${name}:end`);

                performance.mark(`define:${name}:start`);

                el.removeAttribute('loading');
                el.setAttribute('ready', "");
                el.style.viewTransitionName = 'match-element';
                el.style.viewTransitionClass = el.tagName.toLowerCase();

                this.batches.push(async () => {
                    return await next({ name, asset });
                });
            }

        }

        globalThis.registry = new MyCustomRegistry({
            catalog,
            root: document.body,
            live: true,
            fallback: false,
        });
        console.log('First discover', await registry.discover());


        async function metrics() {
            await Promise.allSettled(
                Object.keys(catalog).map(async (name) => {
                    await customElements.whenDefined(name)
                    await new Promise(requestAnimationFrame)

                    const loaded = performance.getEntriesByName(`load:${name}`);
                    const duration = loaded[0].duration;

                    console.log(`${name} loaded in ${duration.toFixed(2)}ms`);
                })
            );
        }

        await metrics();

    </script>

    <footer>
        <p>Created by <a href="https://github.com/vitorcalejuri">Vitor Calejuri</a></p>
    </footer>

</body>

</html>