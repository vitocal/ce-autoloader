<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>„Ää‚ù∞ce-autoloader‚ù±„Äã Test</title>

	<!-- <link rel="stylesheet" href="styles.css"> -->
	<!-- <link rel="preload" href="styles.css" as="style" onload="this.rel='stylesheet'">
	<noscript> -->
	<link rel="stylesheet" href="styles.css">
	<!-- </noscript> -->


	<link rel="preload" href="https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/dist/themes/prettylights.min.css"
		as="style" onload="this.rel='stylesheet'">
	<noscript>
		<link rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/dist/themes/prettylights.min.css">
	</noscript>


	<script type="importmap">
    {
        "imports": {
            "lit": "https://esm.sh/lit@3.3.1?bundle",
            "syntax-highlight": "https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/+esm"
        }
    }
    </script>

	<style>
		/** The first render of our components (undefined) */
		hero-example {
			width: 100%;
			min-height: 320px;
		}
	</style>
</head>

<body class="container n-reset">
	<h1>‚ù∞ ce-autoloader ‚ù±</h1>
	<figcaption>Load web-components on demand, if and when they're used in the page.</figcaption>

	<hr />

	<ul>
		<li>Automatically Load any web-component on demand, if and when they're used in the page.</li>
		<li>A central registry of components, similar to import maps</li>
		<li>Customize when components are loaded with with loading attribute, `on="idle"` , `on="visible"`,
			`on="interaction"`</li>
		<li>Simple and ergonomic </li>
		<li>No dependencies, framework-independent</li>
		<li>1.7kb gzip, performant! </li>
		<li>Namespaced components - Lazily load any component from any library</li>
	</ul>

	<h1> Usage </h1>

	<not-defined></not-defined>

	<another-error></another-error>

	<p>Import <code>ce-autoloader</code> and declare your component registry. Call <code>discover()</code>
		when you're ready, generally after <strong>load</strong>.
	</p>

	<hero-example></hero-example>


	<h1>Examples</h1>

	<br><br><br>

	<!-- That's heavy, almost 8mb with several duplicated dependencies
    <playground-ide editable-file-system line-numbers resizable on="visible" style="height: 300px">
        <script type="sample/html" filename="index.html">
            <!doctype html>
            <body>
            Hello
            <script type="module" src="./index.js">&lt;/script>
            </body>
        </script>

        <script type="sample/ts" filename="index.ts">
            document.body.appendChild(document.createTextNode("World!"))
        </script>
    </playground-ide>
    -->

	<h1>Examples - <code>on</code> attribute</h1>

	<p>The <code>on</code> attribute allows you to specify when the component should be loaded.
		By default, if no attribute is specified, the component is loaded on the first <code>discover</code>.
	</p>

	<nord-stack gap="m" direction="horizontal">
		<nord-button href="#">Default</nord-button>
		<nord-button href="#" variant="primary">Primary</nord-button>
		<nord-button href="#" variant="danger">Danger</nord-button>
		<nord-button href="#" variant="dashed">
			<nord-icon name="interface-filter"></nord-icon>
			Filter
		</nord-button>
		<nord-button href="#" square>
			<nord-icon name="interface-menu-small" label="Options"></nord-icon>
		</nord-button>
	</nord-stack>

	<p>But we can load when the element is visible in the viewport, or when the user interacts with it.
	</p>

	<three-cube on="interaction">
		<span>And I'll be loaded when you click me</span>
	</three-cube>

	<nord-stack gap="m" on="visible">
		<nord-message highlight unread>
			Ariel Salminen arrived to clinic with Pixie cat.
			<span slot="footer">Just now at Nord Clinic</span>
		</nord-message>
		<nord-message unread>
			Nina Hallikainen arrived to clinic with Durante dog.
			<span slot="footer">20 minutes ago at Nord Clinic</span>
		</nord-message>
		<nord-message unread>
			David Darnes arrived to clinic with Norfryd cat.
			<span slot="footer">2 hours ago at Nord Clinic</span>
		</nord-message>
	</nord-stack>

	<nord-banner variant="success">
		Your order has been shipped and will arrive on May 27th. <a href="#">Track order</a>.
	</nord-banner>

	<nord-dropdown size="s" style="z-index: 1;" on="visible">
		<nord-button slot="toggle">Menu</nord-button>
		<nord-dropdown-item href="#">View profile</nord-dropdown-item>
		<nord-dropdown-item>Settings</nord-dropdown-item>
		<nord-dropdown-item>Show keyboard shortcuts</nord-dropdown-item>
		<nord-dropdown-item>Help & Support</nord-dropdown-item>
		<nord-dropdown-item>API</nord-dropdown-item>
		<nord-dropdown-item>Sign out</nord-dropdown-item>
	</nord-dropdown>

	<nord-table on="visible">
		<table>
			<thead>
				<tr>
					<th class="n-table-align-right">Amount</th>
					<th>Description</th>
					<th>Method</th>
					<th class="n-table-align-right">Date</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td class="n-table-align-right">350,00&thinsp;‚Ç¨</td>
					<td class="n-table-ellipsis">
						Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
						amet
						consectetuer
						adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
						dolor
						sit amet
						consectetuer adipiscing
					</td>
					<td>Card</td>
					<td class="n-table-align-right">20.3.2021</td>
				</tr>
				<tr>
					<td class="n-table-align-right">29,90&thinsp;‚Ç¨</td>
					<td class="n-table-ellipsis">
						Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
						amet
						consectetuer
						adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
						dolor
						sit amet
						consectetuer adipiscing
					</td>
					<td>Card</td>
					<td class="n-table-align-right">19.3.2021</td>
				</tr>
				<tr>
					<td class="n-table-align-right">50,00&thinsp;‚Ç¨</td>
					<td class="n-table-ellipsis">
						Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
						amet
						consectetuer
						adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
						dolor
						sit amet
						consectetuer adipiscing
					</td>
					<td>Card</td>
					<td class="n-table-align-right">18.3.2021</td>
				</tr>
				<tr>
					<td class="n-table-align-right">290,00&thinsp;‚Ç¨</td>
					<td class="n-table-ellipsis">
						Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
						amet
						consectetuer
						adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
						dolor
						sit amet
						consectetuer adipiscing
					</td>
					<td>Card</td>
					<td class="n-table-align-right">17.3.2021</td>
				</tr>
				<tr>
					<td class="n-table-align-right">49,90&thinsp;‚Ç¨</td>
					<td class="n-table-ellipsis">
						Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
						amet
						consectetuer
						adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
						dolor
						sit amet
						consectetuer adipiscing
					</td>
					<td>Card</td>
					<td class="n-table-align-right">16.3.2021</td>
				</tr>
				<tr>
					<td class="n-table-align-right">25,00&thinsp;‚Ç¨</td>
					<td class="n-table-ellipsis">
						Suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum dolor sit
						amet
						consectetuer
						adipiscing suspendisse blandit sodales eros, quis aliquet leo aliquet ultrices lorem ipsum
						dolor
						sit amet
						consectetuer adipiscing
					</td>
					<td>Card</td>
					<td class="n-table-align-right">15.3.2021</td>
				</tr>
			</tbody>
		</table>
	</nord-table>

	<h3>manual</h3>

	<p>When you want more control, you can upgrade a component manually, by using a custom directive name
		and calling `registry.upgrade('myDirective')`
	</p>
	<confetti-button on="manual">
		<nord-button id="confetti" size="l" variant="primary">Throw confetti üéâ</nord-button>
	</confetti-button>
	<script type="module">
		document.getElementById("confetti").addEventListener("click", async () => {
			if (!customElements.get('confetti-button')) {
				let result = await registry.upgrade('manual')
				console.log('result', result);
			}
		});
	</script>

	<hr />
	<h1>Namespaced Components</h1>

	<p>You can lazily import a whole library of components by using namespace <code>myns-*</code></p>
	<p class="leftcenter">
		For example, here we register everything under <code>nord-*</code> namespace, so any component like
		<code>nord-qr-code</code> will
		automatically load! There's no need to declare/import each component manually.
	</p>

	<figure class="right">
		<nord-qrcode value="https://ce-autoloader.com" on="visible"></nord-qrcode>
		<figcaption>
			Send me a ‚ù§Ô∏è via pix
		</figcaption>
	</figure>

	<p> Heres the full loader for <code>nord-*</code></p>

	<pre>
<syntax-highlight language="js">/**
 * Nord Health design system
 */
"nord-*": async (full_name) => {
    const [, namespace, name] = full_name.match(/^([a-z]+)-(.*)/);
    const module = await import(/* @vite-ignore */ `https://esm.sh/@nordhealth/components/lib/${capitalize(name)}.js`);
    if (!customElements.get(full_name)) {
        customElements.define(full_name, module.default);
    }
    return module
},</syntax-highlight>
</pre>

	<hr>

	<h1>Observability & Performance</h1>

	<p>
		Observability is already built-in to the registry, and allows measuring the time-to-load of each component.
		With native `performance` integration, it shows in devtools performance panel and can be exported to your
		observability metrics as usual.
	</p>

	<img src="assets/observability.jpg" alt="Observability has native integration into performance devtools"
		loading="visible">

	<p>
		You can access the metrics by querying `performance.getEntriesByName('load:my-component')`
	</p>

	<h1>Animating enter/exit of components</h1>

	<p>It's possible to animate the components upgrade lifecycle. </p>

	<wc-markdown>
		<script type="wc-content">
            ### Animation feature

            - [x] Implement a hook to allow document.startViewTransition() before loading (transition: callback)
            - [X] Implement a [ce-loading] and [ce-defined] attributes
            - [X] How to start the transition right after the module is loaded, but the DOM
                  was not changed yet.


            Thats hard, because if we startViewTransition(registry.registerComponents), then
            it starts before the loading of the module, and only concludes after, taking many seconds
            without updating the UI.

            If we startViewTransition after it's defined, then it's too late, because the DOM was already
            changed.
        </script>
	</wc-markdown>

	<json-viewer id="json" expand="**" on="eager">
		{ "quiz": { "sport": { "q1": { "question": "Which one is correct team name in NBA?", "options": [ "New York
		Bulls", "Los Angeles Kings", "Golden State Warriros", "Houston Rockets" ], "answer": "Houston Rockets" } },
		"maths": { "q1": { "question": "5 + 7 = ?", "options": [ "10", "11", "12", "13" ], "answer": "12" }, "q2": {
		"question": "12 - 8 = ?", "options": [ "1", "2", "3", "4" ], "answer": "4" } } } }
	</json-viewer>
	<script>
		customElements.whenDefined('json-viewer').then(() => {
			const el = document.getElementById('json');

			el.expandAll();
		})
	</script>

	<script type="module" defer>
		import CERegistry from './src/index.js';
		import ErrorFallback from './src/components/error-fallback.js';

		const ViComponents = (await import('./src/components/vi')).default;

		const capitalize = (str) =>
			str.split('-').map((word) => word.charAt(0).toUpperCase() + word.slice(1)).join('');

		globalThis.process = {
			env: {
				NODE_ENV: 'development'
			}
		}

		const catalog = {

			"syntax-highlight": "https://cdn.jsdelivr.net/npm/syntax-highlight-element@1/+esm",
			"playground-ide": "https://cdn.jsdelivr.net/npm/playground-elements@0.18.1/+esm",
			"json-viewer": "https://esm.sh/@alenaksu/json-viewer",
			"wc-markdown": "https://cdn.skypack.dev/@vanillawc/wc-markdown",

			"hero-example": () => import("./src/components/hero-example.js"),
			"confetti-button": () => import("/src/components/confetti-button.ts"),
			"three-cube": () => import("/src/components/three-cube.js"),

			/**
			 * Nord Health design system
			 */
			"nord-*": async (full_name) => {
				const [, namespace, name] = full_name.match(/^([a-z]+)-(.*)/);
				const module = await import(/* @vite-ignore */ `https://esm.sh/@nordhealth/components/lib/${capitalize(name)}.js`);
				if (!customElements.get(full_name)) {
					customElements.define(full_name, module.default);
				}
				return module
			},

			...ViComponents,
		};

		class MyCustomRegistry extends CERegistry {

			async beforeLoad({ name, el, asset }, next) {
				performance.mark(`load:${name}:start`);

				// add loading/transition-class to all components
				el.setAttribute('ce-loading', 'true');

				await next({ name, el, asset });
			}

			async afterLoad({ name, el, asset }, next) {
				performance.mark(`load:${name}:end`);
				performance.measure(`load:${name}`, `load:${name}:start`, `load:${name}:end`);

				performance.mark(`define:${name}:start`);

				el.removeAttribute('ce-loading');
				el.setAttribute('ce-defined', "");

				if (el.getAttribute('view-transition')) {
					el.style.viewTransitionName = 'match-element';
					el.style.viewTransitionClass = el.tagName.toLowerCase();
				}

				this.batches.push(async () => {
					return await next({ name, asset });
				});
			}

		}

		globalThis.registry = new MyCustomRegistry({
			catalog,
			root: document.body,
			live: true,
			fallback: ErrorFallback,
			defaultDirective: 'visible',
		});
		console.log('Discovered on first run:', await registry.discover());


		async function metrics() {
			await Promise.allSettled(
				Object.keys(catalog).map(async (name) => {
					await customElements.whenDefined(name)
					await new Promise(requestAnimationFrame)

					const loaded = performance.getEntriesByName(`load:${name}`);
					const duration = loaded[0].duration;

					console.log(`${name} loaded in ${duration.toFixed(2)}ms`);
				})
			);
		}

		await metrics();
	</script>

	<footer>
		<p>Created by <a href="https://github.com/vitorcalejuri">Vitor Calejuri</a></p>
	</footer>

</body>

</html>